<%- include('partials/header') %>

    <div class="auth-page">
        <!-- Left: Visual Side -->
        <div class="auth-side auth-side-visual d-none d-lg-flex">
            <div class="auth-visual-content" data-aos="fade-right">
                <div class="auth-visual-icon">
                    <i class="bi bi-person-plus"></i>
                </div>
                <h2 class="auth-visual-title">Join Smart Helper</h2>
                <p class="auth-visual-description">
                    <% if (userType==='helper' ) { %>
                        Start earning by offering your professional skills to thousands of users near you.
                        <% } else { %>
                            Create your account and get access to professional household services on demand.
                            <% } %>
                </p>
                <div class="mt-4">
                    <div class="d-flex align-items-center gap-3 mb-3" style="color: rgba(255,255,255,0.6)">
                        <i class="bi bi-check-circle-fill" style="color: var(--primary-light)"></i>
                        <span>Free to register</span>
                    </div>
                    <div class="d-flex align-items-center gap-3 mb-3" style="color: rgba(255,255,255,0.6)">
                        <i class="bi bi-check-circle-fill" style="color: var(--primary-light)"></i>
                        <span>
                            <%= userType==='helper' ? 'Get bookings near you' : 'Book services instantly' %>
                        </span>
                    </div>
                    <div class="d-flex align-items-center gap-3" style="color: rgba(255,255,255,0.6)">
                        <i class="bi bi-check-circle-fill" style="color: var(--primary-light)"></i>
                        <span>
                            <%= userType==='helper' ? 'Flexible schedule' : 'Verified professionals' %>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Form Side -->
        <div class="auth-side auth-side-form">
            <div class="auth-form-container" data-aos="fade-left">
                <h2 class="auth-form-title">
                    <%= title %>
                </h2>
                <p class="auth-form-subtitle">Fill in your details to get started</p>

                <form id="registerForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="John Doe" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" name="email" placeholder="you@example.com"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password"
                            placeholder="Min 6 characters" required minlength="6"
                            oninput="updatePasswordStrength(this.value)">
                        <div class="password-strength mt-2">
                            <div class="password-strength-bar" id="passwordStrengthBar"></div>
                        </div>
                        <small class="text-muted" id="passwordStrengthText"></small>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phone" name="phone" placeholder="+91 1234567890"
                            required>
                    </div>

                    <% if (userType==='helper' ) { %>
                        <div class="mb-3">
                            <label for="skills" class="form-label">Skills <small class="text-muted">(comma
                                    separated)</small></label>
                            <input type="text" class="form-control" id="skills" name="skills"
                                placeholder="e.g., Plumbing, Electrical" required>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <label for="longitude" class="form-label">Longitude</label>
                                <input type="number" step="any" class="form-control" id="longitude" name="longitude"
                                    required>
                            </div>
                            <div class="col-6">
                                <label for="latitude" class="form-label">Latitude</label>
                                <input type="number" step="any" class="form-control" id="latitude" name="latitude"
                                    required>
                            </div>
                        </div>
                        <% } else { %>
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <label for="street" class="form-label">Street Address</label>
                                    <input type="text" class="form-control" id="street" name="street"
                                        placeholder="123 Main St">
                                </div>
                                <div class="col-6">
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="city" name="city" placeholder="Mumbai">
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <label for="longitude" class="form-label">Longitude <small
                                            class="text-muted">(optional)</small></label>
                                    <input type="number" step="any" class="form-control" id="longitude"
                                        name="longitude">
                                </div>
                                <div class="col-6">
                                    <label for="latitude" class="form-label">Latitude <small
                                            class="text-muted">(optional)</small></label>
                                    <input type="number" step="any" class="form-control" id="latitude" name="latitude">
                                </div>
                            </div>
                            <% } %>

                                <div class="d-grid mb-3">
                                    <button type="submit" class="btn btn-gradient btn-gradient-lg" id="registerBtn">
                                        <i class="bi bi-person-plus me-2"></i>Create Account
                                    </button>
                                </div>
                </form>

                <div class="text-center">
                    <p class="text-muted">Already have an account?
                        <a href="/<%= userType === 'helper' ? 'helper/' : '' %>login" class="fw-semibold">Login here</a>
                    </p>
                    <% if (userType==='helper' ) { %>
                        <p class="text-muted mb-0"><i class="bi bi-person me-1"></i>Not a helper?
                            <a href="/register" class="fw-semibold">Register as User</a>
                        </p>
                        <% } else { %>
                            <p class="text-muted mb-0"><i class="bi bi-tools me-1"></i>Want to offer services?
                                <a href="/helper/register" class="fw-semibold">Register as Helper</a>
                            </p>
                            <% } %>
                </div>
                <div id="message" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        function updatePasswordStrength(password) {
            const bar = document.getElementById('passwordStrengthBar');
            const text = document.getElementById('passwordStrengthText');
            let strength = 0;
            if (password.length >= 6) strength++;
            if (password.length >= 10) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            const levels = ['', 'strength-weak', 'strength-fair', 'strength-good', 'strength-strong', 'strength-strong'];
            const labels = ['', 'Weak', 'Fair', 'Good', 'Strong', 'Very Strong'];
            bar.className = 'password-strength-bar ' + levels[strength];
            text.textContent = password.length > 0 ? labels[strength] : '';
        }

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating account...';

            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                phone: document.getElementById('phone').value
            };

            const messageDiv = document.getElementById('message');
            const isHelper = window.location.pathname.includes('/helper/');

            if (isHelper) {
                formData.skills = document.getElementById('skills').value.split(',').map(s => s.trim());
                formData.location = {
                    type: 'Point',
                    coordinates: [
                        parseFloat(document.getElementById('longitude').value),
                        parseFloat(document.getElementById('latitude').value)
                    ]
                };
            } else {
                formData.address = {
                    street: document.getElementById('street').value,
                    city: document.getElementById('city').value
                };
                const lon = document.getElementById('longitude').value;
                const lat = document.getElementById('latitude').value;
                if (lon && lat) {
                    formData.address.coordinates = [parseFloat(lon), parseFloat(lat)];
                }
            }

            try {
                const apiUrl = isHelper ? '/api/auth/helper/register' : '/api/auth/register';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>Registration successful! Redirecting...</div>';
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 800);
                } else {
                    messageDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-circle me-2"></i>' + data.message + '</div>';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-person-plus me-2"></i>Create Account';
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-circle me-2"></i>' + error.message + '</div>';
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-person-plus me-2"></i>Create Account';
            }
        });
    </script>

    <%- include('partials/footer') %>